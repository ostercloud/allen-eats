<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>My Restaurant Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    /* Map takes full screen */
    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    /* Floating search bar - more glass-like */
    .search-container {
      position: absolute;
      top: 16px;
      left: 16px;
      right: 16px;
      z-index: 1000;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .search-wrapper {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 16px;
      color: #666;
      pointer-events: none;
    }

    .search-box {
      width: 100%;
      padding: 16px 16px 16px 48px;
      border: none;
      border-radius: 16px;
      font-size: 15px;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 4px 24px rgba(0,0,0,0.12), 0 0 0 1px rgba(255,255,255,0.5) inset;
      outline: none;
      transition: all 0.3s ease;
    }

    .search-box:focus {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 8px 32px rgba(0,0,0,0.16), 0 0 0 1px rgba(255,255,255,0.8) inset;
    }

    .search-box::placeholder {
      color: #999;
    }

    /* Icon buttons - glass effect */
    .icon-btn {
      width: 52px;
      height: 52px;
      border: none;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 4px 24px rgba(0,0,0,0.12), 0 0 0 1px rgba(255,255,255,0.5) inset;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      color: #555;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 8px 32px rgba(0,0,0,0.16), 0 0 0 1px rgba(255,255,255,0.8) inset;
      transform: translateY(-2px);
    }

    .icon-btn:active {
      transform: translateY(0);
    }

    .icon-btn.active {
      background: rgba(26, 115, 232, 0.9);
      color: white;
    }

    /* Filter panel - glass morphism */
    .filter-panel {
      position: absolute;
      top: 84px;
      right: 16px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5) inset;
      padding: 20px;
      z-index: 1000;
      min-width: 220px;
      max-width: 300px;
      display: none;
      animation: slideIn 0.25s ease-out;
    }

    .filter-panel.open {
      display: block;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-12px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .filter-panel h3 {
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }

    .filter-group {
      margin-bottom: 16px;
    }

    .filter-group:last-child {
      margin-bottom: 0;
    }

    .filter-label {
      font-size: 12px;
      font-weight: 500;
      color: #666;
      margin-bottom: 8px;
      display: block;
    }

    .filter-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      font-size: 14px;
      font-family: inherit;
      background: rgba(255,255,255,0.8);
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-select:focus {
      outline: none;
      border-color: #1a73e8;
      background: white;
    }

    .clear-filters {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 12px;
      background: rgba(0,0,0,0.05);
      color: #666;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s;
    }

    .clear-filters:hover {
      background: rgba(0,0,0,0.08);
    }

    /* Count badge - floating pill */
    .count-badge {
      position: absolute;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 30, 30, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: white;
      padding: 10px 20px;
      border-radius: 24px;
      font-size: 13px;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    /* Custom popup styles */
    .leaflet-popup-content-wrapper {
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }

    .leaflet-popup-content {
      margin: 14px 18px;
      min-width: 220px;
    }

    .leaflet-popup-tip {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .popup-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #1a1a1a;
    }

    .popup-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }

    .popup-tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
    }

    .popup-tag.cuisine {
      background: #e8f0fe;
      color: #1a73e8;
    }

    .popup-tag.style {
      background: #fef3e8;
      color: #e67700;
    }

    .popup-tag.price {
      background: #e6f4ea;
      color: #137333;
    }

    .popup-address {
      color: #666;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .popup-notes {
      font-size: 13px;
      color: #444;
      font-style: italic;
      margin-bottom: 12px;
      padding: 10px 12px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 3px solid #e0e0e0;
    }

    .popup-source {
      font-size: 11px;
      color: #999;
      margin-bottom: 12px;
    }

    .popup-ratings {
      display: flex;
      gap: 12px;
      margin-bottom: 10px;
    }

    .popup-rating {
      font-size: 13px;
      font-weight: 500;
    }

    .popup-rating.my-rating {
      color: #e85d04;
    }

    .popup-rating.google-rating {
      color: #fbbc04;
    }

    .visited-badge {
      display: inline-block;
      background: #34a853;
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
      vertical-align: middle;
    }

    .popup-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .popup-btn {
      flex: 1;
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      min-width: 70px;
      transition: all 0.2s;
    }

    .popup-btn.primary {
      background: #1a73e8;
      color: white;
    }

    .popup-btn.primary:hover {
      background: #1557b0;
    }

    .popup-btn.secondary {
      background: #f1f3f4;
      color: #333;
    }

    .popup-btn.secondary:hover {
      background: #e8eaed;
    }

    .popup-btn.edit {
      background: #fef3e8;
      color: #e67700;
    }

    .popup-btn.edit:hover {
      background: #fde7d0;
    }

    /* Loading state */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 24px 36px;
      border-radius: 20px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.15);
      z-index: 2000;
      font-size: 14px;
      font-weight: 500;
    }

    /* Error state */
    .error {
      background: #fce8e6;
      color: #c5221f;
      padding: 14px 18px;
      border-radius: 12px;
    }

    /* User location marker */
    .user-location-marker {
      position: relative;
    }

    .user-dot {
      width: 16px;
      height: 16px;
      background: #4285f4;
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(66, 133, 244, 0.5);
      position: absolute;
      top: 2px;
      left: 2px;
    }

    .user-pulse {
      width: 44px;
      height: 44px;
      background: rgba(66, 133, 244, 0.15);
      border-radius: 50%;
      position: absolute;
      top: -12px;
      left: -12px;
      animation: pulse 2s ease-out infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.5);
        opacity: 1;
      }
      100% {
        transform: scale(1.3);
        opacity: 0;
      }
    }

    /* Hide Leaflet attribution on mobile */
    .leaflet-control-attribution {
      font-size: 10px;
      background: rgba(255,255,255,0.7) !important;
      backdrop-filter: blur(4px);
    }

    /* Mobile optimizations */
    @media (max-width: 600px) {
      .search-container {
        top: 12px;
        left: 12px;
        right: 12px;
        gap: 10px;
      }

      .search-box {
        padding: 14px 14px 14px 44px;
        border-radius: 14px;
      }

      .search-icon {
        left: 14px;
      }

      .icon-btn {
        width: 48px;
        height: 48px;
        border-radius: 14px;
      }

      .filter-panel {
        top: 76px;
        left: 12px;
        right: 12px;
        max-width: none;
        border-radius: 18px;
      }

      .count-badge {
        bottom: 24px;
      }
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- Floating search and controls -->
  <div class="search-container">
    <div class="search-wrapper">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="M21 21l-4.35-4.35"></path>
      </svg>
      <input type="text" class="search-box" id="search" placeholder="Search restaurants...">
    </div>
    <button class="icon-btn" id="filterBtn" onclick="toggleFilters()" title="Filters">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
      </svg>
    </button>
    <button class="icon-btn" onclick="openSheet()" title="Edit Spreadsheet">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 20h9"></path>
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
      </svg>
    </button>
  </div>

  <!-- Filter panel -->
  <div class="filter-panel" id="filterPanel">
    <h3>Filters</h3>
    <div class="filter-group">
      <label class="filter-label">Cuisine</label>
      <select class="filter-select" id="cuisineFilter">
        <option value="">All Cuisines</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Style</label>
      <select class="filter-select" id="styleFilter">
        <option value="">All Styles</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Price</label>
      <select class="filter-select" id="priceFilter">
        <option value="">All Prices</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Source</label>
      <select class="filter-select" id="sourceFilter">
        <option value="">All Sources</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Visited</label>
      <select class="filter-select" id="visitedFilter">
        <option value="">All</option>
        <option value="yes">Visited</option>
        <option value="no">Not Visited</option>
      </select>
    </div>
    <button class="clear-filters" onclick="clearFilters()">Clear All</button>
  </div>

  <!-- Count badge -->
  <div class="count-badge" id="count"></div>

  <div class="loading" id="loading">Loading restaurants...</div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ===========================================
    // CONFIGURATION
    // ===========================================

    const GOOGLE_SHEET_ID = '1P1U_HMXQq2OCcyS9RheUDZH0fFcCa-Tc_mUh0JIAtlU';
    const SHEET_NAME = 'Sheet1';
    const DEFAULT_CENTER = [40.7128, -74.0060];
    const DEFAULT_ZOOM = 12;
    const GEOCODE_CACHE_KEY = 'restaurant_geocode_cache';

    // Google Maps API Key (optional - for Google tiles)
    // Get one free at: https://console.cloud.google.com/
    // Enable: Maps JavaScript API
    const GOOGLE_MAPS_API_KEY = ''; // Leave empty to use OpenStreetMap

    // ===========================================
    // APP CODE
    // ===========================================

    let map;
    let markers = [];
    let allRestaurants = [];
    let markerLayer;
    let userLocationMarker = null;
    let userLocation = null;

    function toggleFilters() {
      const panel = document.getElementById('filterPanel');
      const btn = document.getElementById('filterBtn');
      panel.classList.toggle('open');
      btn.classList.toggle('active');
    }

    function clearFilters() {
      document.getElementById('search').value = '';
      document.getElementById('cuisineFilter').value = '';
      document.getElementById('styleFilter').value = '';
      document.getElementById('priceFilter').value = '';
      document.getElementById('sourceFilter').value = '';
      document.getElementById('visitedFilter').value = '';
      applyFilters();
    }

    function getSheetEditUrl() {
      return `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/edit`;
    }

    function openSheet() {
      window.open(getSheetEditUrl(), '_blank');
    }

    function initMap() {
      map = L.map('map', {
        zoomControl: false
      }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);

      L.control.zoom({ position: 'bottomright' }).addTo(map);

      // Use Google Maps tiles if API key provided, otherwise OpenStreetMap
      if (GOOGLE_MAPS_API_KEY) {
        L.tileLayer(`https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4m2!1e0!2sm!2m1!1e2!3m17!2sen-US!3sUS!5e18!12m1!1e68!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcy5lOmx8cC52Om9mZg!4e0!5m1!5f2&key=${GOOGLE_MAPS_API_KEY}`, {
          attribution: '© Google Maps'
        }).addTo(map);
      } else {
        // Use Carto's beautiful basemap (free, no key needed)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
          attribution: '© OpenStreetMap © CARTO',
          subdomains: 'abcd',
          maxZoom: 20
        }).addTo(map);
      }

      markerLayer = L.layerGroup().addTo(map);

      map.on('click', () => {
        document.getElementById('filterPanel').classList.remove('open');
        document.getElementById('filterBtn').classList.remove('active');
      });

      getUserLocation();
    }

    function getUserLocation() {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            const userIcon = L.divIcon({
              className: 'user-location-marker',
              html: '<div class="user-dot"></div><div class="user-pulse"></div>',
              iconSize: [20, 20],
              iconAnchor: [10, 10]
            });

            userLocationMarker = L.marker([userLocation.lat, userLocation.lng], {
              icon: userIcon,
              zIndexOffset: 1000
            }).addTo(map);

            userLocationMarker.bindPopup('You are here');

            if (allRestaurants.length > 0) {
              zoomToNearby();
            } else {
              map.setView([userLocation.lat, userLocation.lng], 14);
            }
          },
          (error) => {
            console.log('Could not get location:', error.message);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000
          }
        );
      }
    }

    function zoomToNearby() {
      if (!userLocation || allRestaurants.length === 0) return;

      const restaurantsWithDistance = allRestaurants.map(r => ({
        ...r,
        distance: getDistance(userLocation.lat, userLocation.lng, r.lat, r.lng)
      })).sort((a, b) => a.distance - b.distance);

      const nearby = restaurantsWithDistance.filter(r => r.distance < 10).slice(0, 10);

      if (nearby.length > 0) {
        const bounds = L.latLngBounds([[userLocation.lat, userLocation.lng]]);
        nearby.forEach(r => bounds.extend([r.lat, r.lng]));
        map.fitBounds(bounds.pad(0.1));
      } else {
        map.setView([userLocation.lat, userLocation.lng], 12);
      }
    }

    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function loadGeocodeCache() {
      try {
        return JSON.parse(localStorage.getItem(GEOCODE_CACHE_KEY)) || {};
      } catch {
        return {};
      }
    }

    function saveGeocodeCache(cache) {
      localStorage.setItem(GEOCODE_CACHE_KEY, JSON.stringify(cache));
    }

    async function geocodeAddress(address, name = '') {
      const cache = loadGeocodeCache();
      const cacheKey = `${name} ${address}`.trim().toLowerCase();

      if (cache[cacheKey]) {
        return cache[cacheKey];
      }

      const searchQuery = name ? `${name}, ${address}` : address;

      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`,
          { headers: { 'User-Agent': 'RestaurantMapApp/1.0' } }
        );

        const data = await response.json();

        if (data && data.length > 0) {
          const result = {
            lat: parseFloat(data[0].lat),
            lng: parseFloat(data[0].lon),
            displayName: data[0].display_name
          };
          cache[cacheKey] = result;
          saveGeocodeCache(cache);
          return result;
        }

        if (name) {
          const fallbackResponse = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,
            { headers: { 'User-Agent': 'RestaurantMapApp/1.0' } }
          );
          const fallbackData = await fallbackResponse.json();
          if (fallbackData && fallbackData.length > 0) {
            const result = {
              lat: parseFloat(fallbackData[0].lat),
              lng: parseFloat(fallbackData[0].lon),
              displayName: fallbackData[0].display_name
            };
            cache[cacheKey] = result;
            saveGeocodeCache(cache);
            return result;
          }
        }
      } catch (error) {
        console.error(`Geocoding error for "${searchQuery}":`, error);
      }

      return null;
    }

    function updateLoadingStatus(current, total) {
      document.getElementById('loading').textContent = `Loading... ${current}/${total}`;
    }

    async function fetchRestaurants() {
      const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

      try {
        const response = await fetch(url);
        const text = await response.text();
        const json = JSON.parse(text.substring(47, text.length - 2));

        // Get headers from cols labels, or fall back to first row
        let headers = json.table.cols.map(col => col.label?.toLowerCase().trim() || '');
        const hasEmptyHeaders = headers.every(h => !h);

        let dataRows = json.table.rows;
        if (hasEmptyHeaders && dataRows.length > 0) {
          // Use first row as headers
          headers = dataRows[0].c.map(cell => (cell?.v || cell?.f || '').toString().toLowerCase().trim());
          dataRows = dataRows.slice(1); // Skip header row
        }

        const rawRestaurants = dataRows.map((row, rowIndex) => {
          const obj = { _rowIndex: rowIndex + (hasEmptyHeaders ? 3 : 2) };
          row.c.forEach((cell, i) => {
            if (headers[i]) {
              obj[headers[i]] = cell?.v || cell?.f || '';
            }
          });
          return obj;
        }).filter(r => r.name);

        const restaurants = [];
        let processed = 0;

        for (const r of rawRestaurants) {
          processed++;
          updateLoadingStatus(processed, rawRestaurants.length);

          let lat = parseFloat(r.lat || r.latitude);
          let lng = parseFloat(r.lng || r.lon || r.longitude);

          if ((!lat || !lng || isNaN(lat) || isNaN(lng)) && r.address) {
            const geocoded = await geocodeAddress(r.address, r.name);
            if (geocoded) {
              lat = geocoded.lat;
              lng = geocoded.lng;
            }
            await new Promise(resolve => setTimeout(resolve, 1000));
          }

          if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
            restaurants.push({
              name: r.name,
              lat, lng,
              address: r.address || '',
              cuisine: r.cuisine || r.type || r.category || '',
              style: r.style || r.dining || r['dining style'] || '',
              price: r.price || r['price range'] || '',
              source: r.source || '',
              notes: r.notes || r.description || '',
              url: r.url || r.link || r.website || '',
              rating: r.rating || '',
              visited: r.visited || '',
              my_rating: r.my_rating || r['my rating'] || '',
              google_rating: r.google_rating || r['google rating'] || '',
              _rowIndex: r._rowIndex
            });
          } else {
            console.warn(`Could not geocode: ${r.name} - ${r.address}`);
          }
        }

        return restaurants;
      } catch (error) {
        console.error('Error fetching data:', error);
        throw new Error('Could not load data. Check that your sheet is published.');
      }
    }

    function createMarker(restaurant) {
      const marker = L.marker([restaurant.lat, restaurant.lng]);

      const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(restaurant.name + ' ' + restaurant.address)}`;
      const editUrl = `${getSheetEditUrl()}#gid=0&range=A${restaurant._rowIndex}`;

      let tagsHtml = '';
      if (restaurant.cuisine) tagsHtml += `<span class="popup-tag cuisine">${restaurant.cuisine}</span>`;
      if (restaurant.style) tagsHtml += `<span class="popup-tag style">${restaurant.style}</span>`;
      if (restaurant.price) tagsHtml += `<span class="popup-tag price">${restaurant.price}</span>`;

      // Build ratings display
      let ratingsHtml = '';
      if (restaurant.my_rating) {
        ratingsHtml += `<span class="popup-rating my-rating">My: ${restaurant.my_rating}/5</span>`;
      }
      if (restaurant.google_rating) {
        ratingsHtml += `<span class="popup-rating google-rating">Google: ${restaurant.google_rating}</span>`;
      }

      // Visited badge
      const visitedBadge = restaurant.visited && restaurant.visited.toString().toLowerCase() === 'yes'
        ? '<span class="visited-badge">Visited</span>'
        : '';

      let popupHtml = `
        <div class="popup-title">${restaurant.name}${visitedBadge}</div>
        ${tagsHtml ? `<div class="popup-tags">${tagsHtml}</div>` : ''}
        ${ratingsHtml ? `<div class="popup-ratings">${ratingsHtml}</div>` : ''}
        ${restaurant.address ? `<div class="popup-address">${restaurant.address}</div>` : ''}
        ${restaurant.notes ? `<div class="popup-notes">${restaurant.notes}</div>` : ''}
        ${restaurant.source ? `<div class="popup-source">Source: ${restaurant.source}</div>` : ''}
        <div class="popup-buttons">
          <a href="${mapsUrl}" target="_blank" class="popup-btn primary">Maps</a>
          ${restaurant.url ? `<a href="${restaurant.url}" target="_blank" class="popup-btn secondary">Web</a>` : ''}
          <a href="${editUrl}" target="_blank" class="popup-btn edit">Edit</a>
        </div>
      `;

      marker.bindPopup(popupHtml);
      marker.restaurant = restaurant;
      return marker;
    }

    function updateMarkers(restaurants) {
      markerLayer.clearLayers();
      markers = [];

      restaurants.forEach(r => {
        const marker = createMarker(r);
        marker.addTo(markerLayer);
        markers.push(marker);
      });

      document.getElementById('count').textContent =
        `${restaurants.length} restaurant${restaurants.length !== 1 ? 's' : ''}`;
    }

    function populateFilters(restaurants) {
      const cuisines = [...new Set(restaurants.map(r => r.cuisine).filter(Boolean))].sort();
      const styles = [...new Set(restaurants.map(r => r.style).filter(Boolean))].sort();
      const prices = [...new Set(restaurants.map(r => r.price).filter(Boolean))].sort((a, b) => a.length - b.length);
      const sources = [...new Set(restaurants.map(r => r.source).filter(Boolean))].sort();

      const cuisineSelect = document.getElementById('cuisineFilter');
      cuisines.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        cuisineSelect.appendChild(option);
      });

      const styleSelect = document.getElementById('styleFilter');
      styles.forEach(s => {
        const option = document.createElement('option');
        option.value = s;
        option.textContent = s;
        styleSelect.appendChild(option);
      });

      const priceSelect = document.getElementById('priceFilter');
      prices.forEach(p => {
        const option = document.createElement('option');
        option.value = p;
        option.textContent = p;
        priceSelect.appendChild(option);
      });

      const sourceSelect = document.getElementById('sourceFilter');
      sources.forEach(s => {
        const option = document.createElement('option');
        option.value = s;
        option.textContent = s;
        sourceSelect.appendChild(option);
      });
    }

    function applyFilters() {
      const searchTerm = document.getElementById('search').value.toLowerCase();
      const cuisineFilter = document.getElementById('cuisineFilter').value;
      const styleFilter = document.getElementById('styleFilter').value;
      const priceFilter = document.getElementById('priceFilter').value;
      const sourceFilter = document.getElementById('sourceFilter').value;
      const visitedFilter = document.getElementById('visitedFilter').value;

      let filtered = allRestaurants.filter(r => {
        if (searchTerm && !r.name.toLowerCase().includes(searchTerm) &&
            !r.cuisine.toLowerCase().includes(searchTerm) &&
            !r.style.toLowerCase().includes(searchTerm) &&
            !r.notes.toLowerCase().includes(searchTerm)) {
          return false;
        }
        if (cuisineFilter && r.cuisine !== cuisineFilter) return false;
        if (styleFilter && r.style !== styleFilter) return false;
        if (priceFilter && r.price !== priceFilter) return false;
        if (sourceFilter && r.source !== sourceFilter) return false;
        if (visitedFilter) {
          const isVisited = r.visited && r.visited.toString().toLowerCase() === 'yes';
          if (visitedFilter === 'yes' && !isVisited) return false;
          if (visitedFilter === 'no' && isVisited) return false;
        }
        return true;
      });

      updateMarkers(filtered);
    }

    async function init() {
      initMap();

      try {
        allRestaurants = await fetchRestaurants();
        document.getElementById('loading').style.display = 'none';

        if (allRestaurants.length === 0) {
          throw new Error('No restaurants found.');
        }

        populateFilters(allRestaurants);
        updateMarkers(allRestaurants);

        if (userLocation) {
          zoomToNearby();
        }

        document.getElementById('search').addEventListener('input', applyFilters);
        document.getElementById('cuisineFilter').addEventListener('change', applyFilters);
        document.getElementById('styleFilter').addEventListener('change', applyFilters);
        document.getElementById('priceFilter').addEventListener('change', applyFilters);
        document.getElementById('sourceFilter').addEventListener('change', applyFilters);
        document.getElementById('visitedFilter').addEventListener('change', applyFilters);

      } catch (error) {
        document.getElementById('loading').innerHTML = `
          <div class="error">
            <strong>Error:</strong> ${error.message}
          </div>
        `;
      }
    }

    init();
  </script>

</body>
</html>
